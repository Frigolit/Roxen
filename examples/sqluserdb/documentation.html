<HTML>
<HEAD><TITLE>SQL User Authentication Module for Roxen</TITLE>
<BODY bgcolor="#ffdead" text="#000000" alink="#ff0000" vlink="#ff0000">

<H1 align=center>SQL User Authentication Module for Roxen</H1>

<H2 align=center>Preamble</H2>
This module fills a hole in Roxen capabilities, and completes the options
an user has in adiministering its site. 
Its purpose is handling authentication data stored in a SQL database.<BR>

<H2 align=center>Copyright and Disclaimer of Warranty</H2>
This software and the accompanying documentation are &copy; 1997-2000
Francesco Chemolli and Roxen IS
Use, reproduction and distribution are allowed
under the terms of the GNU General Public License version 2 or, at
your option, any later version. Use of the software implies you know
all the terms therein explained and that you agree to these terms.<BR>
This program is distributed in the hope that it will be useful,
but <B>WITHOUT ANY WARRANTY</B>; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

<H2 align=center>Design Issues</H2>
This module exploits Pike's unique ability to use an uniform interface
to all supported databases. These currently options include
<A href="http://www.hughes.com.au/">MiniSQL</A>,
<A href="http://www.tcx.se/">MySql</A>,
<A href="http://www.postgresql.org/">PostgreSql</A>,
ODBC, <a href="http://www.oracle.com/>Oracle</a> and
<a href="http://www.sybase.com>Sybase</a>.<br>
While the interface is consistent, unluckily not all those databases follow
ANSI SQL specifications except for very simple queries. This means that the
database creation process couldn't be automated, short of following every
SQL dialect of the supported servers.<BR>
This module can do pretty everything, from simple authentication to driving
an user filesystem or a named FTP server. You need to be very careful
though, since misconfigurations can open dangerous security holes.

<H2 align=center>Setup</H2>
In this description, I assume you know the basics of Roxen confguration and
how to use interactively your SQL server.<P>
First off, make sure the Pike interpreter your Roxen server uses supports
the database of your choice. You might need to recompile your Roxen server
<b>after</b> you have installed your sql server.
Connect to your SQL server, and create a new database. Make sure to grant
the user running the WWW server enough privileges to read the database.<BR>
Notice that the database server doesn't necesarily have to be on the
same host. The host where the database resides, its name and the name of
the table containing the authorization information are configurable, so
you don't have to worry about this at this time. <BR>
Let's suppose that the table is called <TT>passwd</TT>, it must have
<B>at least</B> these column definitions (these are simil-SQL, you'll
have to adapt them to your SQL server's syntax:
<UL>
<LI><TT>username</TT>
<DD>A string or variable-length string. Must be <B>primary key</B>, or
 at least <B>unique index</B>
<LI><TT>passwd</TT>
<DD>A string long exactly 13 characters, must be <B>not null</B>
<LI><TT>uid</TT>
<DD>integer, it needn't be unique but it's recommended to make it such
<LI><TT>gid</TT>
<DD>integer
<LI><TT>homedir</TT>
<DD>A string. I suggest a varchar, long at least 20-30 characters. If it 
 can grow, all the better.
<LI><TT>shell</TT>
<DD>A string. I suggest a varchar, like for homedir
</UL>
<DIV align=center>
<TABLE border=2 width=60%>
<CAPTION>Example: mSQL 2.0 table definition</CAPTION>
<TR><TD>
<PRE>
CREATE TABLE passwd (
	username char(15) NOT NULL,
	passwd char(13) NOT NULL,
	uid int,
	gid int,
	homedir text(20),
	shell text(10)
)

CREATE UNIQUE INDEX pass_index ON passwd (
	username
)
</PRE>
</TABLE>
</DIV>
Notice that you may want to have more tables or more columns for administrative
tasks. It is of course possible.<BR>
We're almost done. Add the module to your virtual server's
configuration. Remember, there can be only one authentication module for
each virtual server.

<H2 align=center>Configuration</H2>
It is pretty straightforward.
<UL>
<LI>Cache entries
<DD>defines whether the
 module should cache in memory decoded password entries. This will allow
 a good performance gain (remember that unless you're running a multithreaded
 Roxen, the server blocks while looking up the database, so it could become
 a serious bottleneck on a busy site. I recommend to leave it on.
<LI>Close the database if not used
<DD>Keeping an unused connection to the database uses one filedescriptor
 and some computing power both on the client side (Roxen) and on the
 server side. If this is set, the database connection will be closed
 if it is idle for more than an amount of time.
<LI>Database close timer
<DD>This is the inactivity timeout for the database connection. You'll have
 to find a balance for your site with this setting: opening a connection
 to the database takes some overhead, so you'll want to keep in somewhat
 high. At the same time, having this too high means you'll have no
 profit from it. I believe (but have no solid proof) that a timeout of
 60 (seconds) or so is best.
<LI>Defaults...
<DD>These are the values returned for users who haven't set theirs: only 
 username and password are mandatory, and you could have no interest in
 the others. However, the database columns must be there, but can be
 left empty. These values are returned in such a case.
<LI>Disable userlist
<DD>In some cases Roxen asks the authorization module a list of all the
 user it knows, for example to print a directory listing of an userfilesystem
 mountpoint. If you have an huge user list, and are not interested
 in such features, you may want to have this flag turned on: memory is
 a scarce resource, and its allocation and deallocation a long task.
<LI>SQL server...
<DD>These are the settings about the server: where it is, what table it
 should use and the authentication information.
</UL>

<H2 align=center>Let's start</H2>
Okay. Your authentication server is now hopefully set up. All you need is
fill in the entries, and test it.<BR>
You will probably want to write your customized application/CGI script/pike
script/whatever to correctly fill in the entries. Especially since you'll
probably have extra administrative information to manage.<BR>
The program <TT>adduser</TT> in the server/bin directory can be used if
such is not the case, or as an example. It simply interactively adds (or
changes) user entries on the table <TT>passwd</TT> in database
<TT>passwd</TT> on whatever server runs on localhost. To change these
settings you'll have to edit the script (I told you it was only a sample
program)<P>
The fields <TT>uid</TT> and <TT>gid</TT> are <B>deprecated</B>. It's in
my opinion simply too dangerous to use them. The only use I can
think of for them is to drive a named ftp upload. This is DANGEROUS!
I will never stress it enough. <BR>
My suggestion is to set the "noobody" user
and group in the administration interface and leave these entries in the
database empty. Also, I'm afraid to say that for implementation reasons,
user ID 0 and group ID 0 (root/root) <B>are not availible</B>. Given
the premises, I don't think I'll ever try to implement a way aroud this.

<H2 align=center>Bugs</H2>
Bugs? What are those? &lt;grin&gt;<BR>
Seriously. Should you notice strange behaviours, first off check your
setup, your SQL server, your authentication.<BR>
Should you find in your debug/default.1 log messages of "cannot open server for
unknown reason", it's quite likely that you have permission problems or
that your SQL server is down.<BR>
If you're VERY SURE everything is fine, try to uncomment the 
<CODE>#define SQLAUTHDEBUG</CODE> line at the beginning of the module and
reload the module.
This will produce a lot of debugging output in the default.1 file.<BR>
Should everything else fail, ask the
<a href="mailto:roxen@roxen.com">Roxen mailing list</a>.

</BODY></HTML>
