PROFIL=
#PROFIL=-pg

LIBS=@LIBS@ $(EXTRALIBS)
CC=@CC@
SRCDIR=@srcdir@
prefix=@prefix@
VPATH=@srcdir@

HAVE_SSL=@ssl@
HAVE_SHUFFLE=@shuffle@

OTHERFLAGS=@CFLAGS@

CFLAGS=-g @DEFS@ $(PREFLAGS) $(OTHERFLAGS)
PREFLAGS=-I. -I$(SRCDIR) -I$(SRCDIR)/../.. -I../..

all: roxen_hostname cgi $(HAVE_SSL) $(HAVE_SHUFFLE) fcgi

pure: purerecgi pureshuffle roxen_hostname puressl

no: 
none:
no-install: 
none-install:
no-localinstall: 
none-localinstall:
-localinstall:
-install:

yes: ssl
yes-install: ssl-install
yes-localinstall: ssl-localinstall

fcgi: 
	(cd fast_cgi; make)
	cp fast_cgi/cgi-fcgi/cgi-fcgi fcgi
	@(strip fcgi || echo)

ssl:	ssl.c Makefile
	$(CC) $(CFLAGS) -L/usr/local/ssl/lib -I/usr/local/ssl/include/ $(ARGS) -o ssl $(SRCDIR)/ssl.c -lssl -lcrypto $(LIBS)
	@(strip ssl || echo)

puressl: ssl.o	Makefile
	purify $(CC) -L/usr/local/ssl/lib -I/usr/local/ssl/include/ $(ARGS) -o puressl ssl.o -lssl -lcrypto $(LIBS)

roxen_hostname: roxen_hostname.o Makefile
	$(CC) $(ARGS) -o roxen_hostname roxen_hostname.o $(LIBS)

cgi: cgi.o Makefile
	$(CC) $(ARGS) -o cgi cgi.o $(LIBS)

purecgi: cgi.o Makefile
	purify $(CC) $(ARGS) -o cgi cgi.o $(LIBS)

shuffle:	shuffle.o
	$(CC) -O $(ARGS) -o shuffle shuffle.o -lthread -lsocket
	@(strip shuffle || echo)


pureshuffle:	shuffle.o
	purify $(CC) -O $(ARGS) -o shuffle shuffle.o -lthread -lsocket

shuffle-install: shuffle
	-/bin/rm -f $(prefix)/roxen/server/bin/shuffle
	/bin/cp shuffle $(prefix)/roxen/server/bin

shuffle-localinstall: shuffle
	-/bin/rm -f $(SRCDIR)/../server/bin/shuffle
	/bin/cp shuffle $(SRCDIR)/../server/bin

ssl-install:	ssl
	-/bin/rm -f $(prefix)/roxen/server/bin/ssl
	/bin/cp ssl $(prefix)/roxen/server/bin

ssl-localinstall:	ssl
	-/bin/rm -f $(SRCDIR)/../server/bin/ssl
	/bin/cp ssl $(SRCDIR)/../server/bin

install: roxen_hostname fcgi cgi $(HAVE_SSL)-install $(HAVE_SHUFFLE)-install
	@for f in roxen_hostname fcgi cgi; do \
		echo Installing $$f...; \
		/bin/rm -f $(prefix)/roxen/server/bin/$$f; \
		if /bin/cp $$f $(prefix)/roxen/server/bin/; then :; \
		else exit 1; fi; \
	done
	@echo Done.

localinstall: fcgi roxen_hostname cgi $(HAVE_SSL)-localinstall $(HAVE_SHUFFLE)-localinstall
	@for f in fcgi roxen_hostname cgi; do \
		echo Installing $$f...; \
		/bin/rm -f $(SRCDIR)/../server/bin/$$f; \
		if /bin/cp $$f $(SRCDIR)/../server/bin/; then :; \
		else exit 1; fi; \
	done
	@echo Done.

.c.o:
	$(CC) -c -I. -I$(SRCDIR) $(CFLAGS) $<

clean: 
	@rm -f roxen_hostname cgi shuffle fcgi ssl *.o  core
	@(cd fast_cgi; make clean)

spotless: clean
	@rm -f config.* stamp-h

distribute: spotless
	@rm -f Makefile
