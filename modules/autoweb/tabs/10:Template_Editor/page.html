
<if variable=types>
<sqloutput query="select * from template_vars">
  #name# #type# <br>
</sqloutput>
<br>
</if>

<if variable=help>
<wizard help>
<sqlquery help>
</if>

<pike>
  id->variables->show_wizard=!(id->variables->ok||id->variables->cancel);
  id->variables->show_menu=
    !id->variables->edit||id->variables->ok||id->variables->cancel;
  return "";
</pike>

<if variable=edit>
  <formoutput quote='¤'>
  <sqloutput quote='¥' query="select * from template_wizards where id='¤edit¤'">
  <wizard preparse name="¥title:quote=mysql¥">
    <sqloutput quote='#' query="select * from template_vars where
                      wizard_id='¤edit¤'">
      <page>
       <input type=hidden name=edit value='¤edit:quote=mysql¤'>
       <input type=hidden name=category value='¤category:quote=mysql¤'>
        <h3>#title#</h3>
	<cset preparse variable=options><pike>
	  string query=
	    "<sqloutput quote='£' query="
	    "\"select * from templates where category='¤category¤'\">"
            "£name£,</sqloutput>";
          return ((parse_rxml(query, id)/",")-({ "" }))*",";
	  </pike></cset>
	<cset preparse variable=default><pike>
	  return
	    "<sqloutput quote='£' query="
	    "\"select * from customers_preferences "
	    "where customer_id='¤customer_id¤' and variable_id='#id#'\">"
	    "£value£</sqloutput>";
          </pike></cset>
	<formoutput quote='$'>
	  <var preparse name="variable_#id#" type="#type#"
	        options="$options$" default="$default$">
	</formoutput>
	<br>
        #help#<br>
	<comment>
	  name=variable_#id# type=#type# <br>
          <tablify preparse nice cellseparator='='>Variable=Value
            <insert variables=full></tablify>
	</comment>
      </page>
    </sqloutput>
    <noparse><noparse>
    <done>
      <pike>
        werror("%O\n\n",id->variables);
        string r = "";
	
	foreach(indices(id->variables), string variable) {
          if(sscanf(variable, "variable_%d%*s", int variable_id)>0) {
            r += "<sqlquery query=\""
	         "delete from customers_preferences "
		 "where customer_id='¤customer_id¤' and "
		 "variable_id='"+variable_id+"'"
		 "\">\n";
	    r += "<sqlquery query=\""
	         "insert into customers_preferences "
	         "(customer_id,variable_id,value) "
	         " values ('¤customer_id¤','"+variable_id+"','"+
		 id->variables[variable]+"')"+
		 "\">\n";
	  }
	}
        return r;
      </pike>
    </done></noparse></noparse>
  </wizard>
  </sqloutput>
  </formoutput>
</if>
<if variable=show_menu>

  <h3>Template wizards</h3>
  <blockquote><dl>
    <sqloutput query="select * from template_wizards where category='tmpl'">
      <dt><font size=+1>
         <a href="./?edit=#id#&category=#category#">#name#...</a>
      </font>
      <dd>#title#
    </sqloutput>
  </dl></blockquote>
  <h3>Navigation wizards</h3>
  <blockquote><dl>
    <sqloutput query="select * from template_wizards where category='nav'">
      <dt><font size=+1>
        <a href="./?edit=#id#&category=#category#">#name#...</a>
      </font>
      <dd>#title#
    </sqloutput>
  </dl></blockquote>

  <form method=get>
    <input type=submit name=update value="Update template">
  </form>

  <if variable=update>
    <autosite-webadm-update-template>
  </if>
</if>



<comment>
<tablify preparse nice cellseparator='='>Variable=Value
  <insert variables=full></tablify>
</comment>