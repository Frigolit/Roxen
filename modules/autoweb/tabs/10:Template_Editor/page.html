<define tag=fix_options>
  <pike>
    id->variables->options =
      ((id->variables->options/",")-({ "" }))*",";
    return "";
  </pike>
</define>


<pike>
  id->variables->show_wizard=!(id->variables->ok||id->variables->cancel);
  id->variables->show_menu=
    !id->variables->edit||id->variables->ok||id->variables->cancel;
  return "";
</pike>

<formoutput quote='¤'>
  <cset preparse variable=current_scheme>
    <sqloutput quote='£' query="
      SELECT * FROM customers 
        WHERE id=¤customer_id¤"
      >£template_scheme_id£</sqloutput></cset>
</formoutput>

<if variable=edit>
  <formoutput quote='¤'>

  
    <if variable="edit is change_scheme">
      <wizard preparse name="Change active template">
	<page>
	  <input type=hidden name=edit value='¤edit:quote=mysql¤'>
	  <b>Activate template: </b>

	  <cset preparse variable=options><sqloutput quote='£' query="
	    SELECT * FROM customers_schemes
	      WHERE customer_id='¤customer_id¤'"
	    >£id£:£name£,</sqloutput></cset>
          <fix_options>	  
	  <cset preparse variable=default><sqloutput quote='£' query="
	    SELECT * FROM customers
	      WHERE id=¤customer_id¤">£template_scheme_id£</sqloutput></cset>
	  <formoutput quote='$'>
	    <var name="new_scheme" type="select"
		 options="$options$" default="$default$">
	  </formoutput>
	  <p>
	  Select the template you would like to make active.<br>
	</page>
	<noparse><noparse><done>
	  <formoutput quote=$>
	    <sqlquery query="UPDATE customers
	                       SET template_scheme_id=$new_scheme$
			       WHERE id=$customer_id$">
	  </formoutput>
          <autosite-webadm-update-template>
	</done></noparse></noparse>
      </wizard>
    </if>

    
    <if variable="edit is load_scheme">
      <wizard preparse name="Load predefined template">
	<page>
	  <input type=hidden name=edit value='¤edit:quote=mysql¤'>
	  <b>Load template: </b>
	  <cset preparse variable=options><sqloutput quote='£' query="
	    SELECT * FROM template_schemes">£id£:£name£,</sqloutput></cset>
	  <fix_options>
	  <cset preparse variable=default><sqloutput quote='£' query="
	    SELECT * FROM customers 
	      WHERE id=¤customer_id¤">£template_scheme_id£</sqloutput></cset>
	  <formoutput quote='$'>
	    <var name="load_scheme" type="select"
		 options="$options$" default="$default$">
	  </formoutput>
	  <p>
	  Select the template you would like to load 
	  into the active template.<br>
	</page>
	<noparse><noparse><done>
	  <formoutput quote=$>
	    <sqloutput quote='£'
	       query="SELECT * FROM template_schemes_vars
	                WHERE scheme_id=$load_scheme$">
	      <sqlquery query="DELETE FROM customers_schemes_vars
	                         WHERE scheme_id='$current_scheme$'
			           AND variable_name='£variable_name£'">
              <sqlquery query="INSERT INTO customers_schemes_vars
	                         (scheme_id,variable_name,value)
			         VALUES ('$current_scheme$',
			                 '£variable_name:quote=none£',
				         '£value:quote=none£')">
            </sqloutput>
	  </formoutput>
          <autosite-webadm-update-template>
	</done></noparse></noparse>
      </wizard>
    </if>


    <if variable="edit is new_scheme">
      <wizard preparse name="Create a new template">
	<page>
	  <input type=hidden name=edit value='¤edit:quote=mysql¤'>
	  <b>Template name: </b>
	  <var name=scheme_name type=string size=40><p>
	  Enter a name for your new template.<br>
	</page>
	<page>
	  <input type=hidden name=edit value='¤edit:quote=mysql¤'>
	  <b>Template: </b>
          <cset preparse variable=options><sqloutput quote='£' query="
	    SELECT * FROM template_schemes"
	    >£id£:£name:quote=mysql£,</sqloutput></cset>
	  <fix_options>
	  <formoutput quote='$'>
	    <var name="load_scheme" type="select"
		 options="$options$">
	  </formoutput>	  
	  <p>Select a template you would like your
	      new template to be based on.<br>
	</page>
	<noparse><noparse><done>
	  <formoutput quote=$>
	    <cset preparse variable=scheme_exist><sqloutput quote='£'
	      query="SELECT * FROM customers_schemes
	               WHERE customer_id='$customer_id$'
		         AND name='$scheme_name:quote=mysql$'"
	      >£id£</sqloutput></cset>
            <pike>
	      id->variables->scheme_empty=
	        (id->variables->scheme_exist==""?1:0);
	      return "";
	    </pike>
	    <if variable=scheme_empty>
    	      <sqlquery mysql-insert-id=new_scheme
	        query="INSERT INTO customers_schemes 
	                 (customer_id,name)
		         VALUES ('$customer_id$',
			         '$scheme_name:quote=mysql$')">

              <formoutput quote='¥'>
	        <sqlquery query="UPDATE customers
		                   SET template_scheme_id=¥new_scheme¥
	                           WHERE id=$customer_id$">
  	        <sqloutput quote='£'
	           query="SELECT * FROM template_schemes_vars
	                    WHERE scheme_id=$load_scheme$">
                  <sqlquery
		    query="INSERT INTO customers_schemes_vars
	                     (scheme_id,variable_name,value)
			     VALUES ('¥new_scheme¥',
			             '£variable_name£',
				     '£value:quote=mysql£')">
                </sqloutput>	    
      	      </formoutput>
	    </if>
      	  </formoutput>
          <autosite-webadm-update-template>
	</done></noparse></noparse>
      </wizard>
    </if>


    <if variable="edit is remove_scheme">
      <wizard preparse name="Remove template">
	<page>
	  <input type=hidden name=edit value='¤edit:quote=mysql¤'>
	  <b>Remove template: </b>
          <cset preparse variable=options><sqloutput quote='£' query="
	    SELECT * FROM customers_schemes
	      WHERE customer_id='¤customer_id¤'
	        AND NOT(id='¤current_scheme¤')
	      ORDER BY name">£id£:£name:quote=mysql£,</sqloutput></cset>
	  <fix_options>
	  <formoutput quote='$'>
	    <var name="remove_scheme" type="select"
		 options="$options$">
	  </formoutput>	  
	  <p>Select the template you would like to remove.<br>
	     You can not remove an active template.<br>
	</page>
	<noparse><noparse><done>
	  <formoutput quote=$>
	  <sqlquery
	    query="DELETE FROM customers_schemes
	             WHERE customer_id='$customer_id$'
		       AND id='$remove_scheme$'">
	  <sqlquery
	    query="DELETE FROM customers_schemes_vars
	             WHERE scheme_id='$remove_scheme$'">
      	  </formoutput>
	</done></noparse></noparse>
      </wizard>
    </if>

    
    <if variable="edit is template">
      <sqloutput quote='¥' query="SELECT * FROM template_wizards
				    WHERE id='¤wizard¤'">
        <wizard preparse name="¥name:quote=mysql¥">
	  <sqloutput quote='$' query="SELECT * FROM template_wizards_pages
					WHERE wizard_id='¤wizard¤'">
	    <page>
	      <input type=hidden name=edit value='¤edit:quote=mysql¤'>
	      <input type=hidden name=wizard value='¤wizard:quote=mysql¤'>
              <table border=0>
	        <tr><td colspan=2><h3>$title$</h3></td></tr>
	        <sqloutput quote='#' query="SELECT * FROM template_vars
					      WHERE page_id='$id$'">
		  <cset preparse variable=options><sqloutput quote='£' query="
		      SELECT o.value, o.name
		        FROM template_options AS o,
                             template_option_groups as g
			WHERE g.id='#option_group_id#'
			  AND g.id=o.option_group_id"
	            >£value£:£name£,</sqloutput></cset>
                  <fix_options>
		  <cset preparse variable=default><sqloutput quote='£' query="
		      SELECT * FROM customers_schemes_vars
		        WHERE scheme_id='¤current_scheme:quote=mysql¤'
			  AND variable_name='#name:quote=mysql#'"
		    >£value£</sqloutput></cset>
                  <if match='#type# is string'>
		    <cset variable=size>size=40</cset></if>
		  <else><cset variable=size></cset></else>
		  <formoutput quote='£'>
		    <tr>
		      <td><b>#title#:</b></td>
		      <td><var name="variable_#id#" type="#type#"
			       options="£options:quote=none£"
			       default="£default:quote=none£"
			       noexample £size£></td>
		    </tr>
		    <if not match='#help# is '>
		      <tr><td></td><td>#help#</td></tr>
		    </if>
		  </formoutput>
		</sqloutput>
		<noparse><noparse>
		  <if not match="$example_html:quote=none$ is ">
		    <tr>
		      <td><input type=submit name=example value=Example></td>
                      <td><comment><hr width=100% align=center noshade size=1>
		          </comment>
		        <if variable=example>
			  $example_html:quote=none$
		        </if>
		      </td>
		    </tr>
		  </if>
		</noparse></noparse>
	      </table>
	    </page>
	  </sqloutput>
	  <noparse><noparse><done>
	    <pike>
	      //werror("\nSaving to database customer: ¤customer_id¤\n");
	      string r = "";
	      foreach(indices(id->variables), string variable)
		if((sscanf(variable, "variable_%d%s",
			  int variable_id, string slask)>0)&&(slask=="")) {
		  //werror("%s=%s\n", variable, id->variables[variable]);
		  r += "<sqloutput quote=£ query=\"\n"
		       "  SELECT name \n"
		       "    FROM template_vars \n"
		       "    WHERE id="+variable_id+"\">\n"
		       "  <sqlquery query=\""
		       "    DELETE FROM customers_schemes_vars \n"
		       "      WHERE scheme_id='¤current_scheme¤' \n"
		       "        AND variable_id='"+variable_id+"'\">\n"
		       "  <sqlquery query=\""
		       "    INSERT INTO customers_schemes_vars \n"
		       "      (scheme_id,variable_name,value) \n"
		       "      VALUES ('¤current_scheme¤',\n"
		       "              '£name£',\n"
		       "              '"+id->variables[variable]+"')\">\n"
		       "</sqloutput>\n";
		}
	      return r;
	    </pike>
            <autosite-webadm-update-template>
	  </done></noparse></noparse>
	</wizard>
      </sqloutput>
    </if>
    
    
  </formoutput>
</if>
<if variable=show_menu>
  <formoutput quote='¤'>
    <cset preparse variable=current_scheme><pike>
      return
        "<sqloutput quote='£' query="
        "\"select * from customers "
        "where id=¤customer_id¤\">"
        "£template_scheme_id£</sqloutput>";
    </pike></cset>
  </formoutput>

  <comment><toolbar><toolbarlayout>
    <toolbarbuttonlayout name="Load..." href="./?edit=load_scheme"
                         help="Load predefined template">
			 
    <toolbarbuttonlayout name="New..." href="./?edit=new_scheme"
                         help="Create a new template">
			 
    <toolbarbuttonlayout name="Change..." href="./?edit=change_scheme"
                         help="Change active template">

    <toolbarbuttonlayout name="Remove..." href="./?edit=remove_scheme"
                         help="Remove template">
			 
  </toolbarlayout></toolbar></comment>
  <h3>Layout</h3>
  <blockquote><dl>
    <sqloutput query="select * from template_wizards where category='tmpl'">
      <dt><font size=+1>
         <a href="./?edit=template&wizard=#id#">#name#...</a>
      </font>
      <dd>#title#
    </sqloutput>
  </dl></blockquote><br>

  <h3>Navigation</h3>
  <blockquote><dl>
    <sqloutput query="select * from template_wizards where category='nav'">
      <dt><font size=+1>
        <a href="./?edit=template&wizard=#id#">#name#...</a>
      </font>
      <dd>#title#
    </sqloutput>
  </dl></blockquote><br>
  <h3>Template Functions</h3>
  <formoutput quote='¤'>
    <sqloutput quote='£' query="select * from customers_schemes where
                                id=¤current_scheme¤">
      <b>Active template:</b> £name:quote=mysql£<br>
    </sqloutput>
  </formoutput>
</if>


<comment>
<!--  Debug  -->
<tablify preparse nice cellseparator='='>Variable=Value
  <insert variables=full></tablify>
</comment>
