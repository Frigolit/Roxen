#!/bin/sh

datadir="$1" # Supplied from roxen.
basedir="$2"
bindir="$basedir/libexec/"
shift;shift
. bin/functions

if [ ! -f $bindir/mysqld ] ; then
  obindir="$bindir"
  bindir="$basedir/bin/"
  if [ ! -f $bindir/mysqld ] ; then
    dp "No Mysql in $bindir or $obindir"
    dp "Aborting."
    exit 1
  fi
fi

pid_file=$datadir/mysql_pid
log=$datadir/log
err_log=$datadir/error_log

# dp "Starting mysql with databases from $datadir"
MYSQL_UNIX_PORT="$datadir/socket"
export MYSQL_UNIX_PORT    

MYSQL_TCP_PORT="0"
export MYSQL_TCP_PORT

raise_limit -silent

echo "Restart at `date`" >> $err_log

# Max packet set to 225Mb or so. 
# Should hopefully be enough...
args="--socket=\"$MYSQL_UNIX_PORT\" "
args="--skip-networking "
args="--set-variable max_allowed_packet=16777215 "
args="$args --skip-locking "
args="$args --set-variable net_buffer_length=8192"
args="$args --basedir=$basedir/ --datadir=$datadir $@ --pid-file=$pid_file"

my_cp() {
  ln "$1" "$2" 2>/dev/null \
  || (cp "$1" "$2" && chmod a+x $2) 2>/dev/null
}

rm -f "bin/roxen_mysql"

my_cp $bindir/mysqld bin/roxen_mysql

if [ -f  bin/roxen_mysql ] ; then 
  bin/roxen_mysql $args >$err_log 2>&1 &
else
  $bindir/mysqld $args >$err_log 2>&1 &
fi

exit 0