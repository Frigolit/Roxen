#
# Sub makefile for extracting autodoc
#
# $Id: Makefile.in,v 1.2 2001/08/23 18:58:16 nilsson Exp $
#

PIKE=pike

VPATH=@SRCDIR@:.

SRCDIR=@SRCDIR@
PIKEROOT=@PIKEROOT@
ROOT=@ROOT@
BUILDROT=@BUILDROOT@
EXTARGS=@EXTARGS@

XMLFILES=

all: extract

extract: xml recurse

.SUFFIXES: .c .pike .pike.in .pmod .pmod.in .xml

.c.xml: $(PIKEROOT)/bin/autodoc.pike $(PIKEROOT)/bin/mkxml.pike
	@rm -f "$@.new" 2>/dev/null || /bin/true
	@$(PIKE) $(PIKEROOT)/bin/autodoc.pike $(EXTARGS) "$<" >"$@.new" && \
	  mv -f "$@.new" "$@"

.pike.xml: $(PIKEROOT)/bin/autodoc.pike $(PIKEROOT)/bin/mkxml.pike
	@rm -f "$@.new" 2>/dev/null || /bin/true
	@$(PIKE) $(PIKEROOT)/bin/autodoc.pike $(EXTARGS) "$<" >"$@.new" && \
	  mv -f "$@.new" "$@"

.pike.in.xml: $(PIKEROOT)/bin/autodoc.pike $(PIKEROOT)/bin/mkxml.pike
	@rm -f "$@.new" 2>/dev/null || /bin/true
	@$(PIKE) $(PIKEROOT)/bin/autodoc.pike $(EXTARGS) "$<" >"$@.new" && \
	  mv -f "$@.new" "$@"

.pmod.xml: $(PIKEROOT)/bin/autodoc.pike $(PIKEROOT)/bin/mkxml.pike
	@rm -f "$@.new" 2>/dev/null || /bin/true
	@$(PIKE) $(PIKEROOT)/bin/autodoc.pike $(EXTARGS) "$<" >"$@.new" && \
	  mv -f "$@.new" "$@"

.pmod.in.xml: $(PIKEROOT)/bin/autodoc.pike $(PIKEROOT)/bin/mkxml.pike
	@rm -f "$@.new" 2>/dev/null || /bin/true
	@$(PIKE) $(PIKEROOT)/bin/autodoc.pike $(EXTARGS) "$<" >"$@.new" && \
	  mv -f "$@.new" "$@"

xml:
	$(MAKE) PIKE="$(PIKE)" `(cd $(SRCDIR) && (ls -d *.c *.pike *.pike.in *.pmod *.pmod.in 2>/dev/null | while read f; do if [ -f "$$f" ]; then echo $$f; fi; done))|sed -e 's/\.c$$/\.xml/' -e 's/\.pike$$/\.xml/' -e 's/\.pike.in$$/\.xml/' -e 's/\.pmod\.in$$/\.xml/' -e 's/\.pmod$$/\.xml/' ` xml_dummy

xml_dummy:


join: recurse_join
	@if ls */*.xml >/dev/null 2>&1; then \
	  $(MAKE) PIKE="$(PIKE)" XMLFILES="`echo */*.xml`" sub_manual.xml || \
	    exit 1; \
	fi

sub_manual.xml: $(XMLFILES) $(PIKEROOT)/bin/join-autodoc.pike
	@$(PIKE) $(PIKEROOT)/bin/join-autodoc.pike sub_manual.xml $(XMLFILES)

recurse_join:
	@for d in */.; do \
	  if test -d "$$d"; then \
	    (cd $$d && make PIKE="$(PIKE)" join) || exit 1; \
	  fi; \
	done

images: recurse_images
	@if ls */*.xml >/dev/null 2>&1; then \
	  $(MAKE) PIKE="$(PIKE)" XMLFILES="`echo */*.xml`" low_images || \
	    exit 1; \
	fi

low_images: $(XMLFILES) $(PIKEROOT)/bin/autodoc_images.pike
	@$(PIKE) $(PIKEROOT)/bin/autodoc_images.pike $(ROOT)/manual/images $(XMLFILES)

recurse_images:
	@for d in */.; do \
	  if test -d "$$d"; then \
	    (cd $$d && make PIKE="$(PIKE)" images) || exit 1; \
	  fi; \
	done

recurse: subdirectories
	@for d in */.; do \
	  if test -d "$$d"; then \
	    (cd $$d && make PIKE="$(PIKE)" extract) || exit 1; \
	  fi; \
	done

subdirectories:
	@for d in `cd $(SRCDIR) && echo *` CVS; do \
	  if test "$$d" = "CVS" -o ! -d "$(SRCDIR)/$$d/."; then :; else \
	    if test -d "$$d"; then :; else \
	      mkdir "$$d" || exit 1; \
	    fi; \
	    if test -f "$$d/Makefile"; then :; else \
	      sed -e "s#@""SRCDIR@#../$(SRCDIR)/$$d#" \
	          -e "s#@""PIKEROOT@#$(PIKEROOT)#" \
	          -e "s#@""ROOT@#../$(ROOT)#" \
	          -e "s#@""BUILDROOT@#../$(BUILDROOT)#" \
	          -e "s#@""EXTARGS@#$(EXTARGS)#" \
	        <$(ROOT)/Makefile.in >"$$d/Makefile" || exit 1; \
	    fi; \
	  fi; \
	done

Makefile: $(ROOT)/Makefile.in
#	cd $(BUILDROOT) && find . -name Makefile -exec rm {} \;
	rm Makefile
	@echo Please rerun make.
	@exit 1

clean:
	@rm *.xml *.xml.new || /bin/true
	@for f in *; do if [ -d "$$f/." ]; then rm -rf "$$f"; else :; fi; done
